# K1921VG015 CMake Demos

Примеры проектов для микроконтроллера **НИИЭТ К1921ВГ015** (ядро RISC-V) с использованием системы сборки **CMake** и среды разработки **VS Code**.

Репозиторий включает в себя **SEGGER Flash Loader**, разработанный специально для К1921ВГ015, который обеспечивает быструю и надежную прошивку внутренней Flash-памяти при использовании отладчиков **J-Link** (V11 и выше) без необходимости использования OpenOCD.

## Структура репозитория

```text
.
├── k1921vg015/              # Примеры проектов
│   ├── 01-default/          # Базовый шаблон проекта (Blinky / Startup)
│   ├── rtt-default/         # Пример с использованием SEGGER RTT
│   └── segger-flash-loader/ # Исходный код загрузчика для J-Link
└── modules/                 # Подмодули и внешние библиотеки
```

## Требования к окружению

### Аппаратное обеспечение

* Отладочная плата с К1921ВГ015 (например, [BlueBird-VG015](https://электроника-и-программирование.рф/VG015/1-VG015_devboard.html)).
* Отладчик **J-Link EDU / Base / Plus** аппаратной версии **V11** или выше.
  * *Примечание:* Более старые версии J-Link могут некорректно работать с JTAG-цепочкой этого чипа в прямом режиме.

### Программное обеспечение

1. **VS Code** — редактор кода.
2. **CMake** (версии 3.19 или выше).
3. **Ninja** — система сборки (рекомендуется) или Make.
4. **GCC RISC-V Toolchain** — компилятор.
   * Рекомендуется: [xPack GNU RISC-V Embedded GCC](https://github.com/xpack-dev-tools/riscv-none-elf-gcc-xpack).
5. **J-Link Software and Documentation Pack** — драйверы и утилиты SEGGER.

### Расширения для VS Code

* **C/C++** (Microsoft).
* **CMake Tools** (Microsoft).
* **Cortex-Debug** (marus25) — для отладки.

## Установка J-Link Flash Loader (Обязательно!)

Для того чтобы J-Link мог прошивать внутреннюю память К1921ВГ015, необходимо один раз установить файлы поддержки в системную папку J-Link.

1. Перейдите в папку с загрузчиком:
   `k1921vg015/segger-flash-loader/`

2. Соберите проект загрузчика в конфигурации **Release** (или возьмите готовый файл из `build/Release/segger-flash-loader.elf`, если он есть в репозитории).

3. Скопируйте следующие три файла:
   * `K1921VG015.xml`
   * `K1921VG015.jlinkscript`
   * `build/Release/segger-flash-loader.elf` (переименуйте в `loader.elf` или проверьте, как указано в XML)

4. Разместите их в папке настроек пользователя J-Link:
   * **Windows:** `%AppData%\SEGGER\JLinkDevices\NIIET\`
     *(Пример пути: `C:\Users\User\AppData\Roaming\SEGGER\JLinkDevices\NIIET\`)*
   * **Linux:** `$HOME/.config/SEGGER/JLinkDevices/NIIET/`

5. Убедитесь, что в файле `K1921VG015.xml`, который вы скопировали, путь к `Loader` указан относительно (просто имя файла):

   ```xml
   <FlashBankInfo ... Loader="loader.elf" ... />
   ```

После этого J-Link будет автоматически распознавать устройство `K1921VG015` и использовать ваш быстрый алгоритм прошивки во всех программах (VS Code, Ozone, J-Flash).

## Сборка и запуск примеров

1. **Клонирование**

   ```bash
   git clone --recurse-submodules https://github.com/ViacheslavMezentsev/demo-niiet-cmake
   ```

2. **Настройка**
   Укажите путь к тулчейну `riscv-none-elf-gcc` в переменной среды `PATH` или в настройках `CMakeLists.txt` (`CMAKE_TOOLCHAIN_FILE`).

3. **Сборка (на примере 01-default)**
   * Откройте папку `k1921vg015/01-default` в VS Code.
   * Выберите Kit с компилятором GCC RISC-V.
   * Нажмите **Build** (F7).

4. **Отладка**
   * Перейдите во вкладку "Run and Debug".
   * Выберите конфигурацию **Debug (gdb/jlink)**.
   * Нажмите `F5`.

   Прошивка будет автоматически загружена во Flash память с использованием установленного лоадера, и отладка начнется с функции `main`.

## Проект Segger Flash Loader

В папке `k1921vg015/segger-flash-loader` находится исходный код самого алгоритма прошивки.
Он оптимизирован для работы блоками по 1024 байта, что обеспечивает высокую скорость записи.

**Ключевые особенности реализации:**

* Использует **RAM** контроллера (адрес `0x40000000`) для загрузки кода и буфера данных.
* Поддерживает команды `EraseSector`, `ProgramPage` и `Init/UnInit`.
* Содержит скрипт `K1921VG015.jlinkscript` для корректной инициализации JTAG-цепочки (выбор ядра RISC-V с ID `0x00000D5B`).

### Отладка в Ozone (Черновая поддержка)

В корне проекта `01-default` находятся файлы для запуска отладчика Ozone:

* `K1921VG015.jdebug` — файл проекта Ozone.
* `Reset.JLinkScript` — скрипт для корректной идентификации TAP-контроллера.

**Проблема:** В JTAG-цепочке микроконтроллера находятся два устройства: ядро RISC-V и системный контроллер. Ozone по умолчанию может не определить, к какому устройству подключаться.

**Решение:** Используется `Reset.JLinkScript`, который явно задает ID устройства:

```c
int InitTarget(void) {
  int r;
  // Явное указание ID ядра RISC-V (0x00000D5B) в позиции 0 цепочки
  r = JLINK_JTAG_SetDeviceId(0, 0x00000D5B);
  // Конфигурация сканирования
  r = JLINK_CORESIGHT_Configure("IRPre=0;DRPre=0;IRPost=0;DRPost=0;IRLenDevice=0");
  return r;
}
```

Для запуска откройте файл `K1921VG015.jdebug` в Ozone. Убедитесь, что путь к `.elf` файлу в настройках Ozone соответствует вашему пути сборки.
