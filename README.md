# K1921VG015 CMake Demos

Примеры проектов для микроконтроллера **НИИЭТ К1921ВГ015** (ядро RISC-V) с использованием системы сборки **CMake** и среды разработки **VS Code**.

Репозиторий ориентирован на прямую отладку через **SEGGER J-Link** (версии V11 и выше) без использования OpenOCD, а также содержит экспериментальную поддержку отладчика **SEGGER Ozone**.

## Структура репозитория

```text
.
├── k1921vg015/          # Примеры проектов
│   ├── 01-default/      # Базовый шаблон проекта (Blinky / Startup)
│   └── rtt-default/     # Пример с использованием SEGGER RTT
└── modules/             # Подмодули и внешние библиотеки
```

## Требования к окружению

Для сборки и отладки проектов необходимо установить следующие инструменты:

### Аппаратное обеспечение

* Отладочная плата с К1921ВГ015 (например, [BlueBird-VG015](https://электроника-и-программирование.рф/VG015/1-VG015_devboard.html)).
* Отладчик **J-Link EDU / Base / Plus** аппаратной версии **V11** или выше.
  * *Примечание:* Более старые версии J-Link могут не поддерживать корректно специфическую реализацию JTAG/RISC-V в этом чипе при прямой работе (необходимо использовать openocd из документации).

### Программное обеспечение

1. **VS Code** — редактор кода.
2. **CMake** (версии 3.19 или выше).
3. **Ninja** — система сборки (рекомендуется) или Make.
4. **GCC RISC-V Toolchain** — компилятор.
    * Рекомендуется: [xPack GNU RISC-V Embedded GCC](https://github.com/xpack-dev-tools/riscv-none-elf-gcc-xpack).
5. **J-Link Software and Documentation Pack** — драйверы и утилиты SEGGER.
6. **SEGGER Ozone** (опционально) — для продвинутой отладки.

### Расширения для VS Code

* **C/C++** (Microsoft).
* **CMake Tools** (Microsoft).
* **Cortex-Debug** (marus25) — для отладки (несмотря на название, поддерживает J-Link с RISC-V).

## Начало работы

1. **Клонирование репозитория**
   Так как проект может использовать подмодули, клонируйте с флагом `--recurse-submodules`:

   ```bash
   git clone --recurse-submodules https://github.com/ViacheslavMezentsev/demo-niiet-cmake
   ```

2. **Настройка Toolchain**
   Убедитесь, что путь к `riscv-none-elf-gcc` добавлен в `PATH` вашей системы, либо укажите путь к нему в `settings.json` или `CMakeLists.txt` (переменная `CMAKE_TOOLCHAIN_FILE`).

## Проект: 01-default

Это базовый шаблон проекта, содержащий минимально необходимый код для запуска микроконтроллера, инициализации тактирования и работы с GPIO.

### Структура проекта

* `platform/` — BSP и файлы поддержки (базируется на [NIIET RISC-V SDK](https://gitflic.ru/project/niiet/niiet_riscv_sdk)).
* `K1921VG015.svd` — описание регистров периферии.
* `Reset.JLinkScript` — скрипт инициализации J-Link для корректного определения ID ядра RISC-V.

### Сборка в VS Code

1. Откройте папку репозитория в VS Code.
2. Расширение **CMake Tools** должно автоматически обнаружить `CMakeLists.txt`.
3. Выберите кит (Kit) с вашим компилятором `riscv-none-elf-gcc`.
4. Нажмите **Build** (или `F7`).
   Артефакты сборки (`.elf`, `.hex`, `.bin`) появятся в папке `build/`.

### Отладка в VS Code

В проекте настроен файл `.vscode/launch.json` для отладки через **Cortex-Debug** с использованием **J-Link**.

1. Перейдите на вкладку **Run and Debug**.
2. Выберите конфигурацию **Debug (gdb/jlink)**.
3. Нажмите `F5`.

**Особенности конфигурации (`launch.json`):**

* `servertype`: `jlink`
* `device`: `BM-310` (или `SCR1-RV32`, если чип не определен в J-Link).
* `overrideLaunchCommands`: Используется для ручного управления сбросом и установкой регистра `PC` на начало RAM (`0x40000000`), так как при сбросе через JTAG устройство может сбрасываться в ROM.

### Отладка в Ozone (Черновая поддержка)

В корне проекта `01-default` находятся файлы для запуска отладчика Ozone:

* `K1921VG015.jdebug` — файл проекта Ozone.
* `Reset.JLinkScript` — скрипт для корректной идентификации TAP-контроллера.

**Проблема:** В JTAG-цепочке микроконтроллера находятся два устройства: ядро RISC-V и системный контроллер. Ozone по умолчанию может не определить, к какому устройству подключаться.

**Решение:** Используется `Reset.JLinkScript`, который явно задает ID устройства:

```c
int InitTarget(void) {
  int r;
  // Явное указание ID ядра RISC-V (0x00000D5B) в позиции 0 цепочки
  r = JLINK_JTAG_SetDeviceId(0, 0x00000D5B);
  // Конфигурация сканирования
  r = JLINK_CORESIGHT_Configure("IRPre=0;DRPre=0;IRPost=0;DRPost=0;IRLenDevice=0");
  return r;
}
```

Для запуска откройте файл `K1921VG015.jdebug` в Ozone. Убедитесь, что путь к `.elf` файлу в настройках Ozone соответствует вашему пути сборки.
