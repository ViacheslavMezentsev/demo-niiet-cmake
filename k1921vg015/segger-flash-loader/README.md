# SEGGER Flash Loader для К1921ВГ015

В данном проекте реализован кастомный Flash Loader (алгоритм прошивки) для микроконтроллера **НИИЭТ К1921ВГ015**, который позволяет отладчику **SEGGER J-Link** (V11 и выше) выполнять операции стирания и записи встроенной Flash-памяти чипа напрямую.

Проект создан на основе документации SEGGER и спецификаций НИИЭТ.

## Структура проекта

* `src/` — исходные коды загрузчика (`loader.c`).
* `include/` — заголовочные файлы описания регистров К1921ВГ015.
* `platform/` — BSP и вспомогательные файлы (урезанная версия SDK).
* `loader.ld` — специальный скрипт линковщика для размещения секций `PrgCode`, `PrgData` и `DevDscr`, требуемых J-Link.
* `K1921VG015.xml` — файл описания устройства для J-Link.
* `K1921VG015.jlinkscript` — скрипт инициализации JTAG-цепочки (выбор нужного TAP-контроллера).

## Сборка загрузчика

1. Откройте папку проекта в VS Code.
2. Соберите проект через CMake (используется тулчейн `gcc-riscv-none-elf`):
    * Выберите Kit (компилятор).
    * Нажмите **Build**.
3. После успешной сборки в папке `build` появится файл `segger-flash-loader.elf`.
    * Размер бинарника должен быть небольшим (около 7-14 КБ), что с запасом помещается в RAM микроконтроллера (выделено 32 КБ в `loader.ld`).

## Установка и использование в Windows

Чтобы J-Link "увидел" новый микроконтроллер и знал, как его прошивать, необходимо добавить файлы описания и сам загрузчик в директорию настроек пользователя SEGGER.

### Шаг 1: Подготовка файлов

Вам понадобятся три файла из этого репозитория:

1. `build/segger-flash-loader.elf` (скомпилированный загрузчик).
2. `K1921VG015.xml` (описание карты памяти и ссылка на загрузчик).
3. `K1921VG015.jlinkscript` (настройка JTAG ID 0x00000D5B).

### Шаг 2: Копирование в AppData

1. Откройте проводник и перейдите по пути:

    ```
    %AppData%\SEGGER\JLinkDevices\
    ```

    *(Обычно это `C:\Users\<User>\AppData\Roaming\SEGGER\JLinkDevices\`)*.

2. Создайте внутри папку с именем производителя, например `NIIET`.
3. Скопируйте все три файла (`.elf`, `.xml`, `.jlinkscript`) в эту папку:

    ```
    %AppData%\SEGGER\JLinkDevices\NIIET\
    ```

> **Важно:** Убедитесь, что в файле `K1921VG015.xml` путь к загрузчику указан относительно (просто имя файла), так как они лежат в одной папке:
>
> ```xml
> Loader="segger-flash-loader.elf"
> ```

### Шаг 3: Проверка

1. Подключите отладчик J-Link к плате К1921ВГ015.
2. Запустите **J-Link Commander** (`JLink.exe`).
3. Введите команду выбора устройства:

    ```
    device K1921VG015
    ```

4. Выберите интерфейс `JTAG` и скорость (например, `4000` кГц).
5. Если всё настроено верно, J-Link должен успешно подключиться, определить ID ядра и сообщить о готовности.

### Использование в VS Code (Cortex-Debug)

Теперь в проектах прошивок для К1921ВГ015 (например, в `01-default`) в файле `launch.json` достаточно указать имя устройства. J-Link автоматически подхватит загрузчик из папки AppData.

Пример конфигурации `launch.json`:

```json
{
    "name": "Debug (gdb/jlink)",
    "type": "cortex-debug",
    "request": "launch",
    "servertype": "jlink",
    "interface": "jtag",
    "device": "K1921VG015",  // <--- Имя из вашего XML
    "executable": "${config:executable}",
    "runToEntryPoint": "main",
    // ...
}
```

При запуске отладки (F5) J-Link автоматически:

1. Загрузит `segger-flash-loader.elf` в RAM микроконтроллера.
2. Сотрет и запишет Flash-память, используя функции загрузчика.
3. Сбросит микроконтроллер и остановится на точке входа.

## Литература и документация

В папке `doc/` собраны полезные материалы, использованные при разработке:

* **J-Link Device Support Kit (SEGGER Knowledge Base).pdf** — описание процесса добавления новых устройств в J-Link.
* **SEGGER Flash Loader (SEGGER Knowledge Base).pdf** — руководство по написанию алгоритмов прошивки (API загрузчика).
* **Контроллер Flash-памяти (РП-К1921ВГ015-v3).pdf** — описание работы с контроллером Flash (регистры, команды).
* **Регистры контроллера Flash-памяти (РП-К1921ВГ015-v3).pdf** — карта регистров.
* **Быстрый старт К1921ВГ015 (250909).pdf** — общая информация о старте работы с МК.
